<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>å°‘å„¿è‹±è¯­ç¿»ç‰Œï¼ˆå®Œæ•´ç‰ˆï¼‰</title>
<style>
  :root{
    --bg:#fbfdff; --primary:#66aaff; --accent:#ffb86b;
    --card-back:#76b6ff; --card-front:#fff7d6;
  }
  html,body{height:100%;margin:0;font-family: "Helvetica Neue", Arial, sans-serif;background:var(--bg);color:#222}
  .app{max-width:980px;margin:8px auto;padding:12px;box-sizing:border-box}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  h1{font-size:18px;margin:0}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .tabs{display:flex;gap:6px;flex-wrap:wrap}
  .tab{padding:6px 10px;border-radius:8px;background:#f0f0f0;cursor:pointer}
  .tab.active{background:var(--primary);color:#fff;font-weight:600}
  .small{font-size:13px;color:#555}
  .board-wrap{display:flex;gap:16px;flex-wrap:wrap;margin-top:12px}
  .left{flex:1;min-width:260px}
  .right{width:260px;min-width:220px}
  #grid{display:grid;gap:10px;width:100%}
  /* grid columns responsive */
  @media(min-width:480px){ #grid{grid-template-columns:repeat(4,1fr)}}
  @media(max-width:479px){ #grid{grid-template-columns:repeat(3,1fr)}}

  /* card */
  .card {
    perspective:900px;
    width:100%;
  }
  .card-inner{
    position:relative;width:100%;padding-top:100%; /* square via padding hack */
    transform-style:preserve-3d;transition:transform .5s cubic-bezier(.2,.9,.3,1);
    border-radius:12px;
  }
  .card.open .card-inner{ transform: rotateY(180deg) }
  .face{
    position:absolute;left:0;top:0;right:0;bottom:0;border-radius:12px;
    display:flex;align-items:center;justify-content:center;backface-visibility:hidden;
    box-shadow: 0 4px 8px rgba(0,0,0,.08);
    user-select:none;
  }
  .face.front{
    background:var(--card-front);color:#333;border:2px solid #ffc77d;transform:rotateY(180deg);
    padding:6px;text-align:center;font-size:16px;
  }
  .face.back{
    background:var(--card-back);color:#fff;font-size:28px;
  }
  .face img{max-width:70%;max-height:70%;object-fit:contain}

  .hidden-mask{background:#dcdcdc;color:transparent}
  .matched .card-inner{transform:rotateY(180deg)}
  .matched .face.front{background:#c6ffd6;border-color: #77d36b}
  .checkmark{position:absolute;right:6px;bottom:6px;font-size:18px;color:green}

  /* top-right music toggle */
  .music-toggle{display:flex;align-items:center;gap:6px;padding:6px 8px;border-radius:8px;background:#fff;border:1px solid #eee;cursor:pointer}
  .scorecard{background:#fff;padding:10px;border-radius:10px;box-shadow:0 6px 18px rgba(10,10,20,.04)}
  .meta{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .btn{padding:6px 10px;border-radius:8px;background:var(--primary);color:#fff;border:none;cursor:pointer}
  .btn.secondary{background:#eee;color:#333}
  .controls-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .star{position:absolute;pointer-events:none}
  /* fireworks canvas */
  #fxCanvas{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:9999;display:none}

  /* difficulty / timer */
  .option {padding:6px;border-radius:6px;background:#fff;border:1px solid #eee;cursor:pointer}
  .option.active{background:var(--accent);color:#fff}

  footer{margin-top:18px;font-size:13px;color:#666;text-align:center}
</style>
</head>
<body>
<div class="app">
  <header>
    <div>
      <h1>å°‘å„¿è‹±è¯­ç¿»ç‰Œæ¸¸æˆï¼ˆå®Œæ•´ç‰ˆï¼‰</h1>
      <div class="small">ä¸­è‹±åŒæç¤º â€¢ 3D ç¿»ç‰Œ â€¢ éŸ³æ•ˆ & çƒŸèŠ± â€¢ æœ¬åœ°æœ€é«˜åˆ†è®°å½•</div>
    </div>

    <div class="controls">
      <div class="music-toggle" id="musicToggle" title="åˆ‡æ¢èƒŒæ™¯éŸ³ä¹">
        <span id="musicIcon">ğŸ”ˆ</span><small id="musicText">èƒŒæ™¯éŸ³ä¹</small>
      </div>
      <div class="music-toggle" id="muteSfx" title="åˆ‡æ¢éŸ³æ•ˆ">
        ğŸ”” <small id="sfxText">éŸ³æ•ˆ</small>
      </div>
    </div>
  </header>

  <!-- tabs -->
  <div style="margin-top:12px" id="tabsWrap">
    <div class="tabs" id="tabs"></div>
  </div>

  <div class="board-wrap">
    <div class="left">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <div class="controls-row">
          <div>éš¾åº¦:</div>
          <div class="option" data-diff="6">ç®€å•(6å¯¹)</div>
          <div class="option" data-diff="8">ä¸­ç­‰(8å¯¹)</div>
          <div class="option" data-diff="10">å›°éš¾(10å¯¹)</div>
          <div style="margin-left:10px" class="option" id="autoUp" title="è‡ªåŠ¨è¿›çº§">è‡ªåŠ¨è¿›çº§</div>
        </div>

        <div class="controls-row">
          <div>è®¡æ—¶æ¨¡å¼:</div>
          <div class="option" id="timerToggle">å…³é—­</div>
          <div style="min-width:120px;text-align:right">
            <button class="btn" id="restartBtn">é‡æ–°å¼€å§‹</button>
          </div>
        </div>
      </div>

      <div id="grid" style="margin-top:12px"></div>
    </div>

    <div class="right">
      <div class="scorecard">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small">å½“å‰åˆ†ç±»</div>
            <div id="currentCat" style="font-weight:700">åŠ¨ç‰©</div>
          </div>
          <div style="text-align:right">
            <div class="small">æœ¬æ¬¡å¾—åˆ†</div>
            <div id="scoreNow" style="font-size:20px;font-weight:700">0</div>
          </div>
        </div>

        <hr style="margin:10px 0" />
        <div style="display:flex;justify-content:space-between;gap:8px">
          <div>
            <div class="small">æœ¬ç±»æœ€é«˜åˆ†</div>
            <div id="bestScore">0</div>
          </div>
          <div>
            <div class="small">å‰©ä½™æ—¶é—´</div>
            <div id="timeLeft">--</div>
          </div>
        </div>

        <div style="margin-top:10px;display:flex;gap:6px;flex-wrap:wrap">
          <button class="btn" id="hintBtn">æœ—è¯»ç¤ºä¾‹</button>
          <button class="btn secondary" id="toggleInfo">è¯´æ˜</button>
        </div>
      </div>

      <div style="margin-top:12px;font-size:13px;color:#555">
        <div style="font-weight:600;margin-bottom:6px">æ“ä½œè¯´æ˜</div>
        <div>1) é¡µé¢é¡¶éƒ¨é€‰æ‹©åˆ†ç±»ã€‚ 2) é€‰æ‹©éš¾åº¦/è®¡æ—¶åç‚¹å‡»å¼€å§‹æˆ–é‡æ–°å¼€å§‹ã€‚ 3) å¼€å±€æ˜¾ç¤º 5 ç§’åç¿»é¢ã€‚ 4) ç‚¹å‡»å›¾æˆ–å•è¯é…å¯¹ï¼Œç­”å¯¹åæ˜¾ç¤ºä¸­æ–‡å¹¶å¾—åˆ†ã€‚ </div>
      </div>
    </div>
  </div>
</div>

<canvas id="fxCanvas"></canvas>

<!-- éŸ³é¢‘èµ„æºï¼ˆå¯æ›¿æ¢ä¸ºæœ¬åœ°æ–‡ä»¶ï¼‰ -->
<!-- èƒŒæ™¯éŸ³ä¹ï¼šè½»å¿«å¡é€š loop (mixkit preview) -->
<audio id="bgMusic" loop crossorigin="anonymous" src="https://assets.mixkit.co/music/preview/mixkit-happy-upbeat-children-2018.mp3"></audio>
<!-- æ­£ç¡®/é”™è¯¯éŸ³æ•ˆ -->
<audio id="sndCorrect" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
<audio id="sndWrong" src="https://assets.mixkit.co/active_storage/sfx/1109/1109-preview.mp3"></audio>

<script>
/* ---------- é…ç½®åŒº: åˆ†ç±»ä¸èµ„æº (å¯ä»¥æŒ‰éœ€æ›¿æ¢å›¾ç‰‡ URL) ---------- */
const CATEGORIES = {
  "åŠ¨ç‰©": [
    { img:"./img/cat.png", word:"cat", cn:"çŒ«" },
    { img:"./img/dog.png", word:"dog", cn:"ç‹—" },
    { img:"./img/monkey.png", word:"monkey", cn:"çŒ´å­" },
    { img:"./img/lion.png", word:"lion", cn:"ç‹®å­" },
    { img:"./img/panda.png", word:"panda", cn:"ç†ŠçŒ«" },
    { img:"./img/rabbit.png", word:"rabbit", cn:"å…”å­" },
    { img:"./img/elephant.png", word:"elephant", cn:"å¤§è±¡" },
    { img:"./img/horse.png", word:"horse", cn:"é©¬" },
    { img:"./img/giraffe.png", word:"giraffe", cn:"é•¿é¢ˆé¹¿" },
    { img:"./img/fish.png", word:"fish", cn:"é±¼" },
    { img:"./img/goldfish.png", word:"goldfish", cn:"é‡‘é±¼" },
    {img:"./img/dolphin.png",word:"dolphin",cn:"æµ·è±š"},
    {img:"./img/penguin.png",word:"penguin",cn:"ä¼é¹…"},
    {img:"./img/koala.png",word:"koala",cn:"æ ‘è¢‹ç†Š"},
    {img:"./img/kangaroo.png",word:"kangaroo",cn:"è¢‹é¼ "},
    {img:"./img/rhino.png",word:"rhino",cn:"çŠ€ç‰›"},
    {img:"./img/polar-bear.png",word:"polar bear",cn:"åŒ—æç†Š"},
    {img:"./img/zebra.png",word:"zebra",cn:"æ–‘é©¬"},
    {img:"./img/owl.png",word:"owl",cn:"çŒ«å¤´é¹°"},
    {img:"./img/crocodile.png",word:"crocodile",cn:"é³„é±¼"},
    {img:"./img/eagle.png",word:"eagle",cn:"è€é¹°"},
    {img:"./img/bee.png",word:"bee",cn:"èœœèœ‚"},
    {img:"./img/butterfly.png",word:"butterfly",cn:"è´è¶"},
    {img:"./img/cow.png",word:"cow",cn:"ç‰›"},
    {img:"./img/chick.png",word:"chick",cn:"å°é¸¡"},
    {img:"./img/ox.png",word:"ox",cn:"ç‰›"},
    {img:"./img/duck.png",word:"duck",cn:"é¸­å­"},
    {img:"./img/shark.png",word:"shark",cn:"é²¨é±¼"},
    {img:"./img/jellyfish.png",word:"jellyfish",cn:"æ°´æ¯"},
    {img:"./img/octopus.png",word:"octopus",cn:"ç« é±¼"},
    {img:"./img/snail.png",word:"snail",cn:"èœ—ç‰›"},
    {img:"./img/goldfish.png",word:"goldfish",cn:"é‡‘é±¼"},
    {img:"./img/frog.png",word:"frog",cn:"é’è›™"},
    {img:"./img/hedgehog.png",word:"hedgehog",cn:"åˆºçŒ¬"},
    {img:"./img/turtle.png",word:"turtle",cn:"ä¹Œé¾Ÿ"},
    {img:"./img/ostrich.png",word:"ostrich",cn:"é¸µé¸Ÿ"},
    {img:"./img/peacock.png",word:"peacock",cn:"å­”é›€"},
    {img:"./img/camel.png",word:"camel",cn:"éª†é©¼"},,
    {img:"./img/parrot.png",word:"parrot",cn:"é¹¦é¹‰"},
    {img:"./img/hippopotamus.png",word:"hippopotamus",cn:"æ²³é©¬"},
    {img:"./img/walrus",word:"walrus",cn:"æµ·è±¡"}
  ],
  "äº¤é€š": [
    { img:"./img/car.png", word:"car", cn:"æ±½è½¦" },
    { img:"./img/bus.png", word:"bus", cn:"å…¬äº¤è½¦" },
    { img:"./img/bike.png", word:"bike", cn:"è‡ªè¡Œè½¦" },
    { img:"./img/train.png", word:"train", cn:"ç«è½¦" },
    { img:"./img/airplane.png", word:"airplane", cn:"é£æœº" },
    { img:"./img/ship.png", word:"ship", cn:"èˆ¹" },
    { img:"./img/taxi.png", word:"taxi", cn:"å‡ºç§Ÿè½¦" },
    { img:"./img/truck.png", word:"truck", cn:"å¡è½¦" },
    { img:"./img/motorbike.png", word:"motorbike", cn:"æ‘©æ‰˜è½¦" },
    { img:"./img/subway.png", word:"subway", cn:"åœ°é“" }
  ],
  "é¢œè‰²": [
    { img:"./img/red.png", word:"red", "cn":"çº¢è‰²" },
    { img:"./img/blue.png",word:"blue", "cn":"è“è‰²" },
    { img:"./img/yellow.png", word:"yellow", "cn":"é»„è‰²" },
    { img:"./img/green.png", word:"green", "cn":"ç»¿è‰²" },
    { img:"./img/purple.png", word:"purple", "cn":"ç´«è‰²" },
    { img:"./img/orange.png", word:"orange", "cn":"æ©™è‰²" },
    { img:"./img/black.png", word:"black", "cn":"é»‘è‰²" },
    { img:"./img/white.png", word:"white", "cn":"ç™½è‰²" },
    { img:"./img/brown.png", word:"brown", "cn":"æ£•è‰²" },
    { img:"./img/grey.png", word:"grey", "cn":"ç°è‰²" }
  ],
  "æ•™å…·": [
    { img:"./img/pencil.png", word:"pencil", "cn":"é“…ç¬”" },
    { img:"./img/book.png", word:"book", "cn":"ä¹¦" },
    { img:"./img/crayon.png", word:"crayon", "cn":"èœ¡ç¬”" },
    { img:"./img/ruler.png", word:"ruler", "cn":"å°ºå­" },
    { img:"./img/notebook.png", word:"notebook", "cn":"ç¬”è®°æœ¬" },
    { img:"./img/schoolbag.png", word:"schoolbag", "cn":"ä¹¦åŒ…" },
    { img:"./img/scissors.png", word:"scissors", "cn":"å‰ªåˆ€" },
    { img:"./img/eraser.png", word:"eraser", "cn":"æ©¡çš®" },
    { img:"./img/pen.png", word:"pen", "cn":"é’¢ç¬”" },
    { img:"./img/pencil-case.png", word:"pencil case", "cn":"é“…ç¬”ç›’" },
    { img:"./img/drawing-book.png", word:"drawing book", "cn":"ç”»ç”»æœ¬" }
  ],
  "å®¶åº­": [
    { img:"./img/mother.png", word:"mother", "cn":"å¦ˆå¦ˆ" },
    { img:"./img/father.png", word:"father", "cn":"çˆ¸çˆ¸" },
    { img:"./img/baby.png", word:"baby", "cn":"å©´å„¿" },
    { img:"./img/grandma.png", word:"grandma", "cn":"å¥¶å¥¶/å¤–å©†" },
    { img:"./img/grandpa.png", word:"grandpa", "cn":"çˆ·çˆ·/å¤–å…¬" },
    { img:"./img/brother.png", word:"brother", "cn":"å…„å¼Ÿ/å¼Ÿå¼Ÿ" },
    { img:"./img/sister.png", word:"sister", "cn":"å§å¦¹/å§å§" },
    { img:"./img/uncle.png", word:"uncle", "cn":"èˆ…èˆ…/å”å”" },
    { img:"./img/aunt.png", word:"aunt", "cn":"å§‘å§‘/é˜¿å§¨" },
    { img:"./img/eldest-brother.png", word:"eldest brother", "cn":"å¤§å“¥" }
  ],
  "ç©å…·": [
    { img:"./img/teddy-bear.png", word:"teddy bear", "cn":"æ³°è¿ªç†Š" },
    { img:"./img/ball.png", word:"ball", "cn":"çƒ" },
    { img:"./img/toy-car.png", word:"toy car", "cn":"ç©å…·è½¦" },
    { img:"./img/robot.png", word:"robot", "cn":"æœºå™¨äºº" },
    { img:"./img/top.png", word:"top", "cn":"é™€èº" },
    { img:"./img/blocks.png", word:"blocks", "cn":"ç§¯æœ¨" },
    { img:"./img/puzzle.png", word:"puzzle", "cn":"æ‹¼å›¾" },
    { img:"./img/kite.png", word:"kite", "cn":"é£ç­" },
    { img:"./img/skateboard.png", word:"skateboard", "cn":"æ»‘æ¿" },
    { img:"./img/model-car.png", word:"model car", "cn":"æ±½è½¦æ¨¡å‹" }
  ],
  "ä¹å™¨": [
    { img:"./img/guitar.png", word:"guitar", "cn":"å‰ä»–" },
    { img:"./img/piano.png", word:"piano", "cn":"é’¢ç´" },
    { img:"./img/drum.png", word:"drum", "cn":"é¼“/æ¶å­é¼“" },
    { img:"./img/trumpet.png", word:"trumpet", "cn":"å°å·" },
    { img:"./img/violin.png", word:"violin", "cn":"å°æç´" },
    { img:"./img/maracas.png", word:"maracas", "cn":"æ²™é”¤" },
    { img:"./img/accordion.png", word:"accordion", "cn":"æ‰‹é£ç´" },
    { img:"./img/oboe.png", word:"oboe", "cn":"åŒç°§ç®¡" },
    { img:"./img/flute.png", word:"flute", "cn":"é•¿ç¬›" },
    { img:"./img/cello.png", word:"cello", "cn":"å¤§æç´" },
    { img:"./img/trumpet.png", word:"trumpet", "cn":"å°å·" },
    { img:"./img/saxophone.png", word:"saxophone", "cn":"è¨å…‹æ–¯ç®¡" },
    { img:"./img/harp.png", word:"harp", "cn":"ç«–ç´" },
    { img:"./img/harmonica.png", word:"harmonica", "cn":"å£ç´" }
  ]
};

/* ---------- çŠ¶æ€ ---------- */
let currentCategory = Object.keys(CATEGORIES)[0];
let difficulty = 6; // å¯¹æ•°ï¼ˆ6å¯¹é»˜è®¤ï¼‰
let autoUpgrade = false;
let timerMode = false;
let timeLimit = 60; // é»˜è®¤60sï¼ŒæŒ‰éš¾åº¦ä¹Ÿå¯è°ƒ
let gameCards = []; // ç‰Œæ± 
let flipped = [];
let matched = new Set();
let score = 0;
let bestScores = {}; // å­˜ localStorage
const STORAGE_KEY = "kids_match_best_v1";

/* ---------- DOM ---------- */
const tabsDiv = document.getElementById("tabs");
const grid = document.getElementById("grid");
const currentCatEl = document.getElementById("currentCat");
const scoreNowEl = document.getElementById("scoreNow");
const bestScoreEl = document.getElementById("bestScore");
const timeLeftEl = document.getElementById("timeLeft");
const restartBtn = document.getElementById("restartBtn");
const musicToggle = document.getElementById("musicToggle");
const muteSfxBtn = document.getElementById("muteSfx");
const bgMusic = document.getElementById("bgMusic");
const sndCorrect = document.getElementById("sndCorrect");
const sndWrong = document.getElementById("sndWrong");
const hintBtn = document.getElementById("hintBtn");
const timerToggle = document.getElementById("timerToggle");
const fxCanvas = document.getElementById("fxCanvas");

let timerInterval = null;
let remaining = 0;
let sfxMuted = false;
let musicOn = false;

/* ---------- åˆå§‹åŒ– UI ---------- */
function initUI(){
  // tabs
  tabsDiv.innerHTML = "";
  for(let k of Object.keys(CATEGORIES)){
    const d = document.createElement("div");
    d.className = "tab" + (k===currentCategory ? " active" : "");
    d.innerText = k;
    d.onclick = ()=> {
      currentCategory = k;
      renderTabs();
      startGame(); // åˆ‡æ¢ Tab æ—¶é‡æ–°å¼€å§‹æ¸¸æˆ
    };
    tabsDiv.appendChild(d);
  }
  renderDifficultyOptions();
  renderTabs();

  // controls
  restartBtn.onclick = startGame;
  musicToggle.onclick = toggleMusic;
  muteSfxBtn.onclick = ()=>{ sfxMuted = !sfxMuted; updateSfxBtn(); };
  hintBtn.onclick = ()=>{ speakSample(); };

  // difficulty buttons
  document.querySelectorAll('.option[data-diff]').forEach(el=>{
    el.onclick = ()=> {
      difficulty = Number(el.dataset.diff);
      document.querySelectorAll('.option[data-diff]').forEach(x=>x.classList.remove('active'));
      el.classList.add('active');
      startGame();
    };
  });
  // auto upgrade
  document.getElementById('autoUp').onclick = e=>{
    autoUpgrade = !autoUpgrade;
    e.target.classList.toggle('active', autoUpgrade);
  };
  // timer toggle
  timerToggle.onclick = ()=>{
    timerMode = !timerMode;
    timerToggle.innerText = timerMode ? "å¼€å¯" : "å…³é—­";
    if(timerMode){ timeLimit = Math.max(30, difficulty*8); } // example calc
    startGame();
  };

  // load best scores
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(raw) bestScores = JSON.parse(raw);
  }catch(e){ bestScores = {} }
  updateBestDisplay();
}

/* ---------- è¾…åŠ©ï¼šæœ—è¯» ---------- */
function speak(text){
  if(!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'en-US';
  speechSynthesis.cancel(); // å–æ¶ˆä¸Šä¸€ä¸ªï¼Œé¿å…å †ç§¯
  speechSynthesis.speak(u);
}

/* ---------- æ¸²æŸ“ tabs active ---------- */
function renderTabs(){
  document.querySelectorAll('.tab').forEach(t=>{
    t.classList.toggle('active', t.innerText===currentCategory);
  });
  currentCatEl.innerText = currentCategory;
  updateBestDisplay();
}

/* ---------- æ¸¸æˆé€»è¾‘ ---------- */
function startGame(){
  // reset
  clearInterval(timerInterval);    // æ¸…é™¤æ—§è®¡æ—¶
  matched.clear();
  flipped = [];
  score = 0;
  updateScore();
  timeLeftEl.innerText = '--';
  grid.innerHTML = "";

  // prepare card pool based on difficulty
  const pool = CATEGORIES[currentCategory].slice(); // clone
  // ensure pool has at least difficulty entries; if not, wrap
  while(pool.length < difficulty){
    pool.push(...CATEGORIES[currentCategory].slice());
  }
  // take first `difficulty` unique (shuffle first)
  shuffle(pool);
  const pick = pool.slice(0, difficulty);

  // form cards: for each pick create img-card and word-card (pair by 'word')
  gameCards = [];
  pick.forEach(item => {
    // image card
    gameCards.push({
      id: uniqueId(),
      pair: item.word,
      kind: 'img',
      img: item.img,
      word: item.word,
      cn: item.cn
    });
    // word card
    gameCards.push({
      id: uniqueId(),
      pair: item.word,
      kind: 'word',
      text: item.word,
      word: item.word,
      cn: item.cn
    });
  });

  shuffle(gameCards);

  // render grid columns adapt to count
  const cols = Math.min(4, Math.max(2, Math.ceil(Math.sqrt(gameCards.length))));
  grid.style.gridTemplateColumns = `repeat(${cols},1fr)`;

  gameCards.forEach(card => {
    const el = document.createElement('div');
    el.className = 'card';
    el.dataset.id = card.id;
    el.dataset.pair = card.pair;
    el.dataset.kind = card.kind;
    // inner wrapper for flip effect
    const inner = document.createElement('div');
    inner.className = 'card-inner';
    // front (shows content when face-up)
    const front = document.createElement('div');
    front.className = 'face front';
    if(card.kind === 'img'){
      front.innerHTML = `<img src="${card.img}" alt="${card.word}">`;
    } else {
      front.innerHTML = `<div style="font-size:16px">${escapeHtml(card.text)}</div>`;
    }
    // back (what's visible when face-down)
    const back = document.createElement('div');
    back.className = 'face back';
    back.innerHTML = '?';
    inner.appendChild(front);
    inner.appendChild(back);
    el.appendChild(inner);

    // attach event
    el.onclick = ()=> onCardClick(el, card);

    // start open (show) state for 5s
    el.classList.add('open');
    grid.appendChild(el);
  });

  // æ˜¾ç¤ºå…¨éƒ¨ç‰Œ
  document.querySelectorAll('.card').forEach(c => c.classList.add('open'));

  // after 30s hide all
  setTimeout(()=> {
    document.querySelectorAll('.card').forEach(c=> c.classList.remove('open'));
    // start timer if enabled
    if(timerMode){
      remaining = timeLimit;
      timeLeftEl.innerText = remaining + 's';
      timerInterval = setInterval(()=>{
        remaining--;
        timeLeftEl.innerText = remaining + 's';
        if(remaining <= 0){
          clearInterval(timerInterval);
          failGameByTime();
        }
      }, 1000);
    }
  }, 30000);
}

/* ---------- ç‚¹å‡»ç‰Œé€»è¾‘ ---------- */
function onCardClick(el, card){
  if(el.classList.contains('matched')) return;
  if(el.classList.contains('open')) return;
  if(flipped.length === 2) return; // wait

  // open card
  el.classList.add('open');
  flipped.push({el, card});
  // if word-card opened, speak immediately
  if(card.kind === 'word'){
    speak(card.word);
  }

  if(flipped.length === 2){
    // check after tiny delay
    setTimeout(()=> checkMatch(), 700);
  }
}

/* ---------- åŒ¹é…åˆ¤å®š ---------- */
function checkMatch(){
  const [a,b] = flipped;
  if(!a || !b){ flipped=[]; return; }
  if(a.card.pair === b.card.pair && a.card.kind !== b.card.kind){
    // correct
    matched.add(a.card.pair);
    // mark DOM
    a.el.classList.add('matched'); b.el.classList.add('matched');
    // show Chinese on front as extra feedback (insert small subtext)
    const fA = a.el.querySelector('.face.front');
    const fB = b.el.querySelector('.face.front');
    // append CN if not exists
    if(fA && !fA.querySelector('.cn')) {
      const cnSpan = document.createElement('div'); cnSpan.className='cn'; cnSpan.style.fontSize='12px'; cnSpan.style.marginTop='6px';
      cnSpan.innerText = a.card.cn || '';
      fA.appendChild(cnSpan);
    }
    if(fB && !fB.querySelector('.cn')) {
      const cnSpan = document.createElement('div'); cnSpan.className='cn'; cnSpan.style.fontSize='12px'; cnSpan.style.marginTop='6px';
      cnSpan.innerText = b.card.cn || '';
      fB.appendChild(cnSpan);
    }

    // audio & speak
    if(!sfxMuted) sndCorrect.play();
    speak(a.card.word);

    // score update
    const perPair = Math.floor(100 / (gameCards.length / 2));
    score += perPair;
    if(score > 100) score = 100;
    updateScore();

    // star effect on the matched card
    spawnStar(a.el);
    spawnStar(b.el);

    // check complete
    if(matched.size === gameCards.length / 2){
      gameWin();
    } else if(autoUpgrade && matched.size === gameCards.length / 2){
      // handled in win flow (can auto advance difficulty)
    }

  } else {
    // wrong
    if(!sfxMuted) sndWrong.play();
    // flip back
    a.el.classList.remove('open');
    b.el.classList.remove('open');
  }
  flipped = [];
}

/* ---------- èƒœåˆ© & å¤±è´¥ ---------- */
function gameWin(){
  clearInterval(timerInterval);
  // ensure full score
  score = 100;
  updateScore();
  saveBest();
  // fireworks
  launchFireworks();
  // alert and optionally advance difficulty if enabled
  setTimeout(()=>{
    alert('æ­å–œï¼å…¨éƒ¨ç­”å¯¹ï¼Œè·å¾— 100 åˆ† ğŸ‰');
    if(autoUpgrade){
      // increase difficulty by 2 pairs up to max available
      difficulty = Math.min(10, difficulty+2);
      // mark difficulty buttons
      document.querySelectorAll('.option[data-diff]').forEach(x=>x.classList.toggle('active', Number(x.dataset.diff)===difficulty));
    }
    startGame();
  }, 500);
}

function failGameByTime(){
  // time over
  if(!sfxMuted) sndWrong.play();
  saveBest();
  alert('æ—¶é—´åˆ°ï¼æœ¬æ¬¡å¾—åˆ†ï¼š' + score);
  // do not auto restart immediately; allow user to click restart
}

/* ---------- UI æ›´æ–° ---------- */
function updateScore(){
  scoreNowEl.innerText = String(score);
  updateBestDisplay();
}

function updateBestDisplay(){
  const key = makeKey(currentCategory, difficulty);
  const best = (bestScores[key] || 0);
  bestScoreEl.innerText = String(best);
}

/* ---------- ä¿å­˜æœ¬åœ°æœ€ä½³åˆ† ---------- */
function saveBest(){
  const key = makeKey(currentCategory, difficulty);
  const prev = bestScores[key] || 0;
  if(score > prev){
    bestScores[key] = score;
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(bestScores)); }catch(e){}
  }
  updateBestDisplay();
}

/* ---------- éŸ³ä¹ä¸ SFX æ§åˆ¶ ---------- */
function toggleMusic(){
  musicOn = !musicOn;
  if(musicOn){ bgMusic.play().catch(()=>{}); document.getElementById('musicIcon').innerText='ğŸ”Š'; }
  else { bgMusic.pause(); document.getElementById('musicIcon').innerText='ğŸ”ˆ'; }
  document.getElementById('musicText').innerText = musicOn ? 'éŸ³ä¹ï¼šå¼€' : 'éŸ³ä¹ï¼šå…³';
}

function updateSfxBtn(){
  muteSfxBtn.style.opacity = sfxMuted ? 0.5 : 1;
  document.getElementById('sfxText').innerText = sfxMuted ? 'éŸ³æ•ˆï¼šå…³' : 'éŸ³æ•ˆï¼šå¼€';
}

/* ---------- å°ç‰¹æ•ˆï¼šæ˜Ÿæ˜Ÿ ---------- */
function spawnStar(el){
  const r = el.getBoundingClientRect();
  const star = document.createElement('div');
  star.className='star';
  star.style.left = (r.left + r.width/2) + 'px';
  star.style.top = (r.top + r.height/2) + 'px';
  star.style.position = 'fixed';
  star.style.pointerEvents = 'none';
  star.style.fontSize = '22px';
  star.style.opacity = '1';
  star.innerText = 'â­';
  document.body.appendChild(star);
  const dx = (Math.random()-0.5)*120;
  const dy = -120 - Math.random()*60;
  const dur = 900 + Math.random()*400;
  star.animate([
    { transform:`translate(0,0) scale(1)`, opacity:1 },
    { transform:`translate(${dx}px,${dy}px) scale(.6)`, opacity:0 }
  ], {duration:dur, easing:'cubic-bezier(.2,.9,.3,1)'});
  setTimeout(()=> star.remove(), dur+50);
}

/* ---------- çƒŸèŠ±ï¼ˆcanvasï¼‰ ---------- */
function launchFireworks(){
  const canvas = fxCanvas;
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  canvas.style.display = 'block';
  const ctx = canvas.getContext('2d');
  const particles = [];
  const gravity = 0.04;

  function rand(min,max){ return Math.random()*(max-min)+min; }

  for(let i=0;i<8;i++){
    const cx = rand(canvas.width*0.2, canvas.width*0.8);
    const cy = rand(canvas.height*0.1, canvas.height*0.6);
    const hue = Math.floor(rand(0,360));
    for(let j=0;j<40;j++){
      particles.push({
        x:cx, y:cy,
        vx:Math.cos(j/10*Math.PI*2)*rand(1,6),
        vy:Math.sin(j/10*Math.PI*2)*rand(1,6),
        life:rand(40,110),
        age:0,
        hue:hue+rand(-40,40)
      });
    }
  }

  let anim=0;
  function loop(){
    anim++;
    ctx.fillStyle = 'rgba(0,0,0,0.12)';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    particles.forEach(p=>{
      p.age++;
      p.vy += gravity;
      p.x += p.vx;
      p.y += p.vy;
      const alpha = Math.max(0,1 - p.age/p.life);
      ctx.beginPath();
      ctx.fillStyle = `hsla(${p.hue},90%,60%,${alpha})`;
      ctx.arc(p.x,p.y,Math.max(0,2*alpha),0,Math.PI*2);
      ctx.fill();
    });
    // remove dead
    for(let i=particles.length-1;i>=0;i--){
      if(particles[i].age > particles[i].life) particles.splice(i,1);
    }
    if(particles.length>0) requestAnimationFrame(loop);
    else { ctx.clearRect(0,0,canvas.width,canvas.height); canvas.style.display='none'; }
  }
  loop();
}

/* ---------- å·¥å…·å‡½æ•° ---------- */
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } }
function uniqueId(){ return 'c'+Math.random().toString(36).slice(2,9) }
function makeKey(cat, diff){ return `${cat}__d${diff}` }
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

/* ---------- æœ—è¯»ç¤ºä¾‹ï¼šè¯»å®Œæ•´å¥—å•è¯ ---------- */
function speakSample(){
  const items = CATEGORIES[currentCategory].slice(0, difficulty);
  let idx=0;
  function next(){
    if(idx>=items.length) return;
    speak(items[idx].word);
    idx++;
    setTimeout(next,800);
  }
  next();
}

/* ---------- ç»‘å®šéš¾åº¦ UI ---------- */
function renderDifficultyOptions(){
  // create if missing (first time)
  const container = document.querySelectorAll('.option[data-diff]').length ? null : (()=>{
    const parent = document.querySelector('.controls-row');
    return parent;
  })();
  // ensure the correct difficulty button is active
  setTimeout(()=> {
    document.querySelectorAll('.option[data-diff]').forEach(x=> x.classList.toggle('active', Number(x.dataset.diff)===difficulty));
    document.getElementById('autoUp').classList.toggle('active', autoUpgrade);
  }, 60);
}

/* ---------- startup ---------- */
initUI();
startGame();
updateSfxBtn();

/* ---------- keyboard shortcuts for dev convenience (optional) ---------- */
window.addEventListener('resize', ()=> { fxCanvas.width = window.innerWidth; fxCanvas.height = window.innerHeight; });

</script>
</body>
</html>
