<!DOCTYPE html>
<html lang = "zh">
<head>
  <meta charset = "UTF-8">
  <meta name = "viewport" content = "width = device-width,initial-scale = 1.0" />
  <title>默写单词小游戏</title>
  <style>
    /* 整个滚动条 */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    /* 滚动条轨道 */
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    /* 滚动条滑块 */
    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 10px;
    }

    /* 滑块在鼠标悬停时的样式 */
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
      cursor: pointer;
    }
    body {
      font-family:Arial,sans-serif;
      text-align:center;
      padding:12px;
      background:#f7f7f7;
      overflow: hidden;
    }
    .appContainer {
      display: flex;
    }
    .tabs {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      height: 90vh;
    }
    .tabs .tabs-main {
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      padding-right: 10px;
    }
    .tabs button {
      margin:4px;
      padding:10px 14px;
      border:none;
      background:#eee;
      cursor:pointer;
      border-radius:6px;
      max-width: 200px;
    }
    .tabs button.active {
      background:#007bff;
      color:#fff;
    }
    .mainContainer {
      margin: auto 12px;
      flex: 1;
      font-size: 0;
    }
    #levelSelect {
      margin-top:10px;
      padding:6px 10px;
      border-radius:6px;
    }
    #inputContainer {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #inputContainer input {
      width:40px;
      height:50px;
      font-size:30px;
      text-align:center;
      margin:3px;
      padding:4px;
      text-transform:lowercase;
      border-radius:6px;
      border:2px solid #ccc;
    }

    #inputContainer .placeholder {
      width: 30px;
      height: 52px;
      display: block;
    }
    
    .correct {
      border-color:green;
      color:green;
    }
    .wrong {
      border-color:red;
      color:red;
    }
    button.control-btn {
      padding:10px 14px;
      background: #eee;
      color: #333;
      border:none;
      cursor:pointer;
      border-radius:8px;
      font-size:12px;
      margin: 12px;
    }
    button.control-btn:hover,
    button.active {
      background: #007bff;
      color: #fff;
    }
    .wordContainer {
      display: flex;
      font-size: 26px;
      color: #333;
      margin: 24px 0;
      justify-content: center;
    }
    .hide {
      display: none;
    }
    #wordDisplay {
      font-size: 30px;
      margin-right: 12px;
    }

    @media(max-width: 900px) {
      body {
        padding: 0;
        overflow: auto;
      }

      .appContainer {
        display: block;
      }

      .tabs,
      .tabs .tabs-main {
        display: block;
        height: 400px;
      }

      .mainContainer {
        margin: 30px 0;
        width: 100%;
      }

      #inputContainer input {
        width: 15%;
      }
    }
  </style>
</head>
<body>
  <div class="appContainer">
    <div class="tabs">
      <div class="tabs-main" id="tabContainer"></div>
    </div>
    <div class="mainContainer">
      <!-- <select id="levelSelect">
        <option value="easy">简单(多提示)</option>
        <option value="medium" selected>中等</option>
        <option value="hard">困难(少提示)</option>
      </select> -->
      <button class="control-btn toggleLanguage active" data-word="en">英文</button>
      <button class="control-btn toggleLanguage" data-word="cn">中文</button>
      <button class="control-btn changeIt active" id="nextBtn">下一个单词</button>

      <div class="wordContainer">
        <div id="wordDisplay"></div>
        <div id="meaning" class="hide"></div>
      </div>
      <div id="inputContainer"></div>
    </div>
  </div>

  <audio id="soundCorrect" src="./files/correct.mp3"></audio>
  <audio id="soundWrong" src="./files/wrong.mp3"></audio>

  <script src="./js/jQuery.min.js"></script>

  <script>
    // 分类数据
    let categories = {};
    let words = [];
    let currentIndex = 0;
    const visible = {
      cnWord: false,
      enWord: true
    }
    let reviewList = [];
    const wrongCountMap = {};
    let timer = null;
    const wordDisplay = document.getElementById('wordDisplay');
    const inputContainer = document.getElementById('inputContainer');
    const meaningEl = document.getElementById('meaning');
    const soundCorrect = document.getElementById('soundCorrect');
    const soundWrong = document.getElementById('soundWrong');

    function tabEvents() {
      const tabContainer = document.getElementById('tabContainer');
      for(let cat in categories){
        const btn = document.createElement('button');
        btn.textContent = `${cat}(${categories[cat].length})`;
        btn.onclick = () => {
          document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          words = categories[cat];
          currentIndex = 0;
          reviewList = [];
          loadWord();
        };
        tabContainer.appendChild(btn);
      }
      tabContainer.firstChild.classList.add('active');
    }

    function getNextWord(){
      if(reviewList.length > 0) return reviewList.shift();
      currentIndex = (currentIndex + 1) % words.length;
      return words[currentIndex];
    }

    function nextRender() {
      delete wrongCountMap[words[currentIndex].word.toLowerCase()]
      const nextWord = getNextWord();
      words[currentIndex] = nextWord;
      loadWord();
    }

    function speak(word){
      const msg = new SpeechSynthesisUtterance(word);
      msg.lang='en-US';
      speechSynthesis.speak(msg);
    }

    function loadWord(){
      const wordDisplay = document.getElementById('wordDisplay');
      const data = words[currentIndex];
      const word = data.word.toLowerCase();
      wordDisplay.textContent = word;
      meaningEl.textContent = `/  ${data.cn}`;
      meaningEl.classList[visible.cnWord ? 'remove' : 'add']('hide');
      inputContainer.innerHTML = '';

      const level = 'medium'; // document.getElementById('levelSelect').value;
      let lettersToShow = level === 'easy' ? Math.floor(word.replace(/\s/g,'').length / 2) : (level === 'medium' ? Math.floor(word.replace(/\s/g,'').length / 3) : 1);

      const revealIndexes = [];
      while (revealIndexes.length < lettersToShow) {
        const i = Math.floor(Math.random() * word.length);
        if (word[i].trim() && !revealIndexes.includes(i)) revealIndexes.push(i);
      }

      for (let i = 0; i < word.length; i++) {
        let elem;
        if (!word[i].trim()) {
          elem = document.createElement('span');
          elem.textContent = word[i];
          elem.classList.add('placeholder');
        } else {
          elem = document.createElement('input');
          elem.maxLength = 1;
          elem.dataset.index = i;
          if (revealIndexes.includes(i)) {
            elem.value = word[i];
            elem.disabled = true;
            elem.classList.add('correct');
          }
          elem.addEventListener('input', handleInput);
          elem.addEventListener('keydown', handleDelete);
        }
        inputContainer.appendChild(elem);
      }
      inputContainer.querySelector('input:not([disabled])')?.focus();
    }

    function handleDelete(e) {
      if (e.key === 'Backspace' && !e.target.value) {
        const elements = [...inputContainer.children];
        let i = Number(e.target.dataset.index) - 1;
        while (i >= 0 && (elements[i].tagName.toLowerCase() !== 'input' || elements[i].disabled)) i--;
        if (i >= 0) {
          const prev = elements[i];
          prev.focus();
          prev.value = '';
          prev.classList.remove('wrong', 'correct');
        }
      }
    }

    function handleInput(e){
      clearTimeout(timer);
      const input = e.target;
      input.value = input.value.toLowerCase();
      const word = words[currentIndex].word.toLowerCase();

      if(!inputContainer) return;
      const elements = [...inputContainer.children];
      if(!elements.length) return;

      let wordIndex = 0;
      let hasError = false;

      elements.forEach(elem => {
        if (elem.tagName.toLowerCase() !== 'input') {
          wordIndex++;
          return;
        }
        elem.classList.remove('wrong', 'correct');
        if (elem.value) {
            elem.classList.add(elem.value === word[wordIndex] ?'correct' : 'wrong');
            elem.value !== word[wordIndex] && (hasError = true)
        } else {
          hasError = true;
        }
        wordIndex++;
      });

      // 自动跳到下一个 input
      let nextIndex = Number(input.dataset.index) + 1;
      while (nextIndex < elements.length) {
        const nextElem = elements[nextIndex];
        if (nextElem.tagName.toLowerCase() === 'input' && !nextElem.disabled) break;
        nextIndex++;
      }

      (nextIndex < elements.length) && elements[nextIndex].focus();
      
      if (!hasError && elements.every(el => el.tagName.toLowerCase() !== 'input' || el.value !== '')) {
        speak(word);
        delete wrongCountMap[word]
        reviewList = reviewList.filter(item => item.word.toLowerCase() !== word)
        soundCorrect.play();
        timer = setTimeout(() => {
          nextRender();
        }, 2000);
      } else if (hasError && nextIndex === elements.length) {
        soundWrong.play();
      } else if (hasError) {
        wrongCountMap[word] = (wrongCountMap[word] || 0) + 1;
        if (wrongCountMap[word] >= 2 && !reviewList.includes(words[currentIndex])) reviewList.push(words[currentIndex]);
      }
    }

    document.addEventListener("click", function(ev) {
      const className = event.target.classList.toString();
      const dataWord = event.target.getAttribute('data-word');

      className.includes('changeIt') && nextRender();

      if (!className.includes('toggleLanguage')) return;
      const key = dataWord === 'cn' ? 'cnWord' : 'enWord';
      const dom = dataWord === 'cn' ? meaningEl : wordDisplay
      const otherDom = dataWord === 'en' ? meaningEl : wordDisplay;
      toggleVisible(key, dom);
      ev.target.classList[visible[key] ? 'add' : 'remove']('active');
      const isHide = otherDom.classList.length && otherDom.classList.toString().includes('hide')
      if (dataWord === 'cn') {
        dom.textContent = !isHide ? `/  ${words[currentIndex].cn}` : words[currentIndex].cn
      } else {
        otherDom.textContent = visible[key] ? `/  ${words[currentIndex].cn}` : words[currentIndex].cn
      }
    }, false);

    document.addEventListener('keydown', (ev) => {
      if (ev.key === 'Enter') {
        clearTimeout(timer);
        nextRender();
      }
    });

    function toggleVisible(key, dom) {
      visible[key] = !visible[key];
      dom.classList[visible[key] ? 'remove' : 'add']('hide');
    }

    $.ajax({
      url: './data/ketJson.json',
      type: 'GET',
      dataType: 'json',
      async: false
    }).done(function(data) {
      if (!data) return;
      categories = data;
      const firstWord = Object.keys(data)[0]
      words = data[firstWord]
      loadWord(data, firstWord);
      tabEvents();
    }).fail(function(error) {
      console.error('Error fetching data', error);
    });
  </script>
</body>
</html>
